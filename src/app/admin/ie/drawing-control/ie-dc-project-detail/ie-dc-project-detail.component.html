<div nz-row [nzGutter]="24">
  <div nz-col nzXs="16" nzSm="16" nzMd="16" nzLg="16">
    <nz-collapse>
      <nz-collapse-panel
        [nzHeader]="'Project: ' + project.projectNo"
        [nzActive]="true"
        [nzShowArrow]="true"
      >
        <!-- <nz-card style="width: 100%"></nz-card> -->
        <nz-table
          id="project-info"
          [nzData]="['']"
          nzSize="small"
          nzBordered
          nzFrontPagination="false"
        >
          <tbody>
            <tr>
              <td>
                <dx-text-box
                  label="Project Name"
                  labelLocation="left"
                  showColonAfterLabel="true"
                  [labelMode]="'static'"
                  [(value)]="project.projectName"
                  (onBlur)="updateProject()"
                ></dx-text-box>
              </td>
              <td>
                <dx-text-box
                  label="Line"
                  labelLocation="left"
                  showColonAfterLabel="true"
                  [labelMode]="'static'"
                  [(value)]="project.line"
                  (onBlur)="updateProject()"
                ></dx-text-box>
              </td>
              <td>
                <dx-text-box
                  label="Supplier"
                  labelLocation="left"
                  showColonAfterLabel="true"
                  [labelMode]="'static'"
                  [(value)]="project.supplier"
                  (onBlur)="updateProject()"
                ></dx-text-box>
              </td>
              <td>
                <dx-text-box
                  label="Tact Time"
                  labelLocation="left"
                  showColonAfterLabel="true"
                  [labelMode]="'static'"
                  [(value)]="project.tactTime"
                  (onBlur)="updateProject()"
                ></dx-text-box>
              </td>
            </tr>
          </tbody>
        </nz-table>

        <nz-collapse>
          <nz-collapse-panel
            [nzHeader]="'Progress'"
            [nzActive]="true"
            [nzShowArrow]="true"
          >
            <dx-data-grid
              keyExpr="id"
              #projectGrid
              [dataSource]="progresses"
              [showColumnLines]="true"
              [showRowLines]="true"
              [showBorders]="true"
              [allowColumnResizing]="true"
              [columnAutoWidth]="true"
              (onRowClick)="onClickProgress($event)"
            >
              <dxi-column
                dataField="projectProgressId"
                caption="Progress Id"
              ></dxi-column>
              <dxi-column
                dataField="projectProgressName"
                caption="Progress Name"
              ></dxi-column>
              <dxi-column
                dataField="startPlan"
                caption="Start Plan"
                dataType="date"
                format="yyyy-MM-dd"
              ></dxi-column>
              <dxi-column
                dataField="endPlan"
                caption="End Plan"
                dataType="date"
                format="yyyy-MM-dd"
              ></dxi-column>
              <dxi-column
                dataField="startAction"
                caption="Start Action"
                dataType="date"
                format="yyyy-MM-dd"
              ></dxi-column>
              <dxi-column
                dataField="endAction"
                caption="End Action"
                dataType="date"
                format="yyyy-MM-dd"
              ></dxi-column>

              <dxi-column
                caption="Tiến độ"
                cellTemplate="progressTemplate"
                [fixed]="true"
                fixedPosition="right"
              >
                <div
                  *dxTemplate="let item of 'progressTemplate'"
                  style="text-align: center"
                >
                  <div class="w3-light-grey .w3-round-small">
                    <div
                      class="w3-container w3-green .w3-round-small"
                      [style.width]="
                        item.data.progress == null
                          ? 0
                          : item.data.progress + '%'
                      "
                    >
                      {{ item.data.progress == null ? 0 : item.data.progress }}%
                    </div>
                  </div>
                </div>
              </dxi-column>
            </dx-data-grid>
          </nz-collapse-panel></nz-collapse
        >
      </nz-collapse-panel>
    </nz-collapse>
  </div>
  <div nz-col nzXs="8" nzSm="8" nzMd="8" nzLg="8">
    <nz-collapse>
      <nz-collapse-panel
        [nzHeader]="'Project Activity'"
        [nzActive]="true"
        [nzShowArrow]="true"
      >
        <dx-data-grid
          keyExpr="id"
          #projectActivityGrid
          [dataSource]="activities"
          [showColumnLines]="true"
          [showRowLines]="true"
          [showBorders]="true"
          [allowColumnResizing]="true"
          [columnAutoWidth]="true"
        >
          <dxo-toolbar>
            <dxi-item location="before">
              <dx-button
                stylingMode="outlined"
                type="default"
                icon="plus"
                text="Add Activity"
                (onClick)="openProjectActivityModal()"
              >
              </dx-button>
            </dxi-item>
          </dxo-toolbar>
          <dxi-column
            dataField="date"
            caption="Date"
            dataType="date"
            format="yyyy-MM-dd"
          ></dxi-column>
          <dxi-column dataField="title" caption="Title"></dxi-column>
          <dxi-column dataField="note" caption="Note"></dxi-column>
        </dx-data-grid>
      </nz-collapse-panel>
    </nz-collapse>
  </div>
</div>

<nz-modal
  [(nzVisible)]="isOpenProgressModal"
  [nzTitle]="'Progress: ' + progress.projectProgressName"
  nzWidth="100%"
  [nzFooter]="modalFooter"
  (nzOnCancel)="isOpenProgressModal = false"
>
  <ng-container *nzModalContent>
    <nz-table
      id="project-progress"
      [nzData]="['']"
      nzSize="small"
      nzBordered
      nzFrontPagination="false"
    >
      <tbody>
        <tr>
          <td>
            <dx-number-box
              label="Tiến độ"
              labelLocation="left"
              showColonAfterLabel="true"
              [labelMode]="'static'"
              [(value)]="progress.progress"
              [min]="0"
              [max]="100"
              [step]="5"
              (onBlur)="updateProjectProgress()"
            ></dx-number-box>
          </td>
          <td>
            <dx-date-box
              [(value)]="progress.startPlan"
              label="Start Plan"
              labelLocation="left"
              showColonAfterLabel="true"
              [labelMode]="'static'"
              [displayFormat]="'yyyy-MM-dd'"
              (onValueChanged)="updateProjectProgress()"
            ></dx-date-box>
          </td>
          <td>
            <dx-date-box
              [(value)]="progress.endPlan"
              label="End Plan"
              labelLocation="left"
              showColonAfterLabel="true"
              [labelMode]="'static'"
              [displayFormat]="'yyyy-MM-dd'"
              (onValueChanged)="updateProjectProgress()"
            ></dx-date-box>
          </td>
          <td>
            <dx-date-box
              label="Start Act"
              labelLocation="left"
              showColonAfterLabel="true"
              [labelMode]="'static'"
              [displayFormat]="'yyyy-MM-dd'"
            ></dx-date-box>
          </td>
          <td>
            <dx-date-box
              label="End Act"
              labelLocation="left"
              showColonAfterLabel="true"
              [labelMode]="'static'"
              [displayFormat]="'yyyy-MM-dd'"
            ></dx-date-box>
          </td>
        </tr>
      </tbody>
    </nz-table>

    <nz-table
      [nzData]="['']"
      nzSize="small"
      nzBordered
      nzFrontPagination="false"
    >
      <tbody>
        <tr *ngIf="progress?.projectProgressId == 3">
          <td>File</td>
          <td>
            <dx-tree-list
              #treeList
              class="drawing-tree-list"
              [dataSource]="drawings"
              [rootValue]="null"
              keyExpr="id"
              parentIdExpr="parentId"
              [showRowLines]="true"
              [showBorders]="true"
              [columnAutoWidth]="true"
              [expandedRowKeys]="expandedRowKeys"
              (onSaving)="onSavingDrawing($event)"
              (onSaved)="onSavedDrawing($event)"
              (onCellClick)="onCellClick($event)"
              [height]="650"
              [scrolling]="{
                mode: 'virtual',
                rowRenderingMode: 'virtual',
                columnRenderingMode: 'virtual',
                useNative: false,
                showScrollbar: 'always'
              }"
            >
              <dxo-filter-row [visible]="true"></dxo-filter-row>
              <dxo-search-panel [visible]="true"></dxo-search-panel>

              <dxo-toolbar>
                <dxi-item
                  location="before"
                  name="addRowButton"
                  showText="always"
                ></dxi-item>
                <dxi-item location="before">
                  <dx-button
                    stylingMode="outlined"
                    type="default"
                    icon="upload"
                    text="Upload Drawing Tree"
                    (onClick)="openUploadDrawingTreeModal()"
                  >
                  </dx-button>
                </dxi-item>
                <dxi-item location="before">
                  <dx-button
                    stylingMode="outlined"
                    type="success"
                    icon="upload"
                    text="Upload drawing file"
                    (onClick)="openUploadDrawingFileModal()"
                  >
                  </dx-button>
                </dxi-item>

                <dxi-item location="after" name="searchPanel"></dxi-item>
              </dxo-toolbar>

              <dxo-editing
                mode="popup"
                [allowUpdating]="true"
                [allowAdding]="true"
                [allowDeleting]="true"
              >
                <dxo-popup
                  title="Drawing Information"
                  [showTitle]="true"
                  [width]="800"
                >
                </dxo-popup>
              </dxo-editing>

              <dxi-column
                dataField="drawingNo"
                caption="Drawing No"
              ></dxi-column>
              <dxi-column
                dataField="drawingName"
                caption="Drawing name"
              ></dxi-column>
              <dxi-column dataField="qty" caption="Qty"></dxi-column>

              <dxi-column dataField="unit" caption="Unit"></dxi-column>
              <dxi-column dataField="material" caption="Material"></dxi-column>
              <dxi-column dataField="hardness" caption="Hardness"></dxi-column>

              <dxi-column
                dataField="polishing"
                caption="Polishing"
              ></dxi-column>
              <dxi-column dataField="supplier" caption="Supplier"></dxi-column>
              <dxi-column dataField="version" caption="Version"></dxi-column>
              <dxi-column dataField="remark" caption="Remark"></dxi-column>
            </dx-tree-list>
          </td>
        </tr>
        <tr *ngIf="progress?.projectProgressId !== 3">
          <td>File</td>
          <td></td>
        </tr>
      </tbody>
    </nz-table>
  </ng-container>
  <ng-template #modalFooter>
    <button nz-button nzType="default" (click)="isOpenProgressModal = false">
      Đóng
    </button>
  </ng-template>
</nz-modal>

<nz-modal
  [(nzVisible)]="isOpenProjectActivityModal"
  [nzTitle]="'Project Activity'"
>
  <ng-container *nzModalContent>
    <nz-table
      [nzData]="['']"
      nzSize="small"
      nzBordered
      nzFrontPagination="false"
      class="project-activity"
    >
      <tbody>
        <tr>
          <td><label>Title</label></td>
          <td>
            <input
              nz-input
              placeholder="Title"
              [(ngModel)]="projectActivity.title"
            />
          </td>
        </tr>
        <tr>
          <td>
            <label>Date</label>
          </td>
          <td>
            <nz-date-picker
              [(ngModel)]="projectActivity.date"
              style="width: 100%"
            ></nz-date-picker>
          </td>
        </tr>
        <tr>
          <td><label>Note</label></td>
          <td>
            <textarea
              rows="3"
              nz-input
              [(ngModel)]="projectActivity.note"
            ></textarea>
          </td>
        </tr>
        <tr>
          <td><label>File</label></td>
          <td>
            <dx-file-uploader
              [multiple]="false"
              selectButtonText="Select file"
              labelText=""
              accept="image/*, .pdf, .doc, .docx, .ppt, .pptx, .xls, .xlsx"
              uploadMode="useForm"
              [inputAttr]="{ 'aria-label': 'Select file' }"
              (onValueChanged)="onValueChangedFile($event, true)"
            >
            </dx-file-uploader>
          </td>
        </tr>
      </tbody>
    </nz-table>
  </ng-container>
  <div *nzModalFooter>
    <button nz-button nzType="primary" (click)="insertProjectActivity()">
      Lưu
    </button>
    <button
      nz-button
      nzType="default"
      (click)="isOpenProjectActivityModal = false"
    >
      Đóng
    </button>
  </div>
</nz-modal>

<nz-modal [(nzVisible)]="isOpenUploadDrawingFileModal" [nzTitle]="'Upload Drawing File'">
  <ng-container *nzModalContent>
    <dx-file-uploader
      [multiple]="true"
      selectButtonText="Select file"
      labelText=""
      accept=".pdf"
      uploadMode="useForm"
      [inputAttr]="{ 'aria-label': 'Select file' }"
      (onValueChanged)="onValueChangedFile($event, true)"
    >
    </dx-file-uploader>
  </ng-container>
  <div *nzModalFooter>
    <button nz-button nzType="primary" (click)="uploadDrawingFile()">Save</button>
    <button
      nz-button
      nzType="default"
      (click)="isOpenUploadDrawingFileModal = false"
    >
      Đóng
    </button>
  </div>
</nz-modal>

<nz-modal
  [(nzVisible)]="isOpenUploadDrawingTreeModal"
  [nzTitle]="'Upload Drawing Tree'"
>
  <ng-container *nzModalContent>
    <dx-file-uploader
      [multiple]="false"
      selectButtonText="Select file"
      labelText=""
      accept=".xlsx"
      uploadMode="useForm"
      [inputAttr]="{ 'aria-label': 'Select file' }"
      (onValueChanged)="onValueChangedFile($event,false)"
    >
    </dx-file-uploader>
  </ng-container>
  <div *nzModalFooter>
    <button nz-button nzType="primary" (click)="uploadDrawingTreeList()">
      Save
    </button>
    <button
      nz-button
      nzType="default"
      (click)="isOpenUploadDrawingTreeModal = false"
    >
      Đóng
    </button>
  </div>
</nz-modal>