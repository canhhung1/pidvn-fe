<div>
  <dx-data-grid
    keyExpr="id"
    #sparePartRecordGrid
    [dataSource]="sparePartRecords"
    [showColumnLines]="true"
    [showRowLines]="true"
    [showBorders]="true"
    [allowColumnResizing]="true"
    [columnAutoWidth]="true"
    [rowAlternationEnabled]="true"
    (onExporting)="onExportClient($event)"
  >
    <dxo-paging [pageSize]="10"></dxo-paging>
    <dxo-filter-row [visible]="true"></dxo-filter-row>
    <dxo-export [enabled]="true"></dxo-export>

    <dxo-column-chooser
      #columnChooser
      [enabled]="true"
      [mode]="'select'"
      [title]="'Cột hiển thị'"
    >
    </dxo-column-chooser>

    <dxo-toolbar>
      <dxi-item location="before">
        <nz-space>
          <button *nzSpaceItem nz-button nzType="primary">
            <span nz-icon nzType="login"></span>
            Hàng nhập về
          </button>
          <button
            *nzSpaceItem
            nz-button
            nzType="primary"
            style="background: #24a835; border: 1px solid #24a835"
            (click)="openOutputSparePartModal()"
          >
            <span nz-icon nzType="logout"></span>
            Xuất kho
          </button>
          <button
            *nzSpaceItem
            nz-button
            nzType="primary"
            style="background: #999695; border: 1px solid #999695"
          >
            <span nz-icon nzType="rotate-left"></span>
            Hàng NG trả về
          </button>
        </nz-space>
      </dxi-item>

      <dxi-item location="after">
        <nz-space>
          <nz-range-picker
            [(ngModel)]="searchParams.dateRange"
            nzFormat="yyyy-MM-dd"
            nzMode="date"
          >
          </nz-range-picker>
          <button nz-button nzType="default" (click)="getSparePartRecords()">
            <span nz-icon nzType="search"></span>
          </button>
        </nz-space>
      </dxi-item>
      <dxi-item name="exportButton" location="after" />
      <dxi-item name="columnChooserButton" location="after"></dxi-item>
    </dxo-toolbar>

    <dxi-column
      dataField="requestNo"
      caption="Số phiếu"
      [visible]="false"
    ></dxi-column>
    <dxi-column dataField="partNumber" caption="Part Number"></dxi-column>
    <dxi-column dataField="galileoName" caption="Galileo Name"></dxi-column>

    <dxi-column dataField="qty" caption="Qty" alignment="right"></dxi-column>
    <dxi-column dataField="type" caption="Type"></dxi-column>
    <dxi-column dataField="machine" caption="Máy"></dxi-column>
    <dxi-column dataField="line" caption="Line"></dxi-column>
    <dxi-column dataField="whUser" caption="WH User"></dxi-column>
    <dxi-column dataField="otherUser" caption="Other User"></dxi-column>
    <dxi-column
      dataField="date"
      caption="Date"
      dataType="date"
      format="yyyy-MM-dd"
    ></dxi-column>
    <dxi-column
      alignment="center"
      dataField="createdAt"
      caption="Time"
      dataType="date"
      format="HH:mm"
    ></dxi-column>
    <dxi-column dataField="remark" caption="Ghi chú"></dxi-column>

    <dxi-column
      caption="Action"
      cellTemplate="actionTemplate"
      [fixed]="true"
      fixedPosition="right"
    ></dxi-column>
    <div *dxTemplate="let item of 'actionTemplate'" style="text-align: center">
      <a (click)="openModalEditSparePartRecord(item)">Sửa</a>
    </div>

    <dxo-summary>
      <dxi-total-item
        column="qty"
        summaryType="sum"
        valueFormat="#,##0"
      ></dxi-total-item>

      <dxi-total-item
        column="totalPrice"
        summaryType="sum"
        valueFormat="#,##0"
      ></dxi-total-item>
    </dxo-summary>

    <dxo-paging [pageSize]="20"></dxo-paging>
    <dxo-pager
      [showPageSizeSelector]="true"
      [allowedPageSizes]="[10, 25, 50, 100]"
    >
    </dxo-pager>
  </dx-data-grid>
</div>

<nz-modal
  [(nzVisible)]="isOpenOutputSparePartModal"
  nzTitle="Nhập xuất Spare Part"
  nzWidth="1300px"
>
  <ng-container *nzModalContent>
    <!-- <nz-table
      [nzData]="['']"
      nzFrontPagination="false"
      nzBordered
      nzSize="small"
    >
      <tbody>
        <tr>
          <td width="25%"><label>Hình thức nhập</label></td>
          <td>
            <nz-radio-group [(ngModel)]="insertType">
              <label nz-radio nzValue="manual">Manual</label>
              <label nz-radio nzValue="excel">Upload Excel</label>
            </nz-radio-group>
          </td>
        </tr>
      </tbody>
    </nz-table> -->
    <!-- <hr style="margin-top: -25px" /> -->

    <ng-container
      *ngIf="insertType == 'excel'; then template2; else template1"
    ></ng-container>

    <ng-template #template1>
      <nz-table
        [nzData]="['']"
        nzFrontPagination="false"
        nzBordered
        nzSize="small"
      >
        <thead>
          <tr>
            <th width="15%">Người nhận</th>
            <th width="20%">
              <input
                id="userCodeIpt"
                [(ngModel)]="userCode"
                #userCodeIpt
                nz-input
                placeholder="Mã nhân viên"
                autocomplete="off"
                (keydown.enter)="scanUserCode($event)"
                (click)="userCodeIpt.select()"
              />
            </th>
            <th>QR Code</th>
            <th>
              <input
                id="sparePartQrCodeIpt"
                #sparePartQrCodeIpt
                nz-input
                placeholder="Mã spare part"
                autocomplete="off"
                (keydown.enter)="scanSparePartQrCode($event)"
                (click)="sparePartQrCodeIpt.select()"
              />
            </th>
          </tr>
        </thead>
      </nz-table>

      <dx-data-grid
        #sparePartOutputGrid
        [showBorders]="true"
        [dataSource]="listSparePartScanned"
        [showColumnLines]="true"
        [showRowLines]="true"
        [allowColumnResizing]="true"
        [columnMinWidth]="50"
        [columnAutoWidth]="true"
        (onSaving)="saveSparePartRecords($event)"
        style="margin-top: -25px"
      >
        <dxo-editing
          mode="batch"
          [allowUpdating]="true"
          [selectTextOnEditStart]="true"
        >
        </dxo-editing>
        <dxi-column
          [width]="225"
          dataField="partNumber"
          caption="Part"
          [allowEditing]="false"
        ></dxi-column>
        <dxi-column [width]="80" dataField="qty" caption="Qty"></dxi-column>
        <dxi-column [width]="200" dataField="factoryCode" caption="Nhà máy">
          <dxi-validation-rule
            type="required"
            message="Cần chọn nhà máy"
          ></dxi-validation-rule>
          <dxo-lookup
            [allowClearing]="true"
            [enterKeyHint]="true"
            [dataSource]="factories"
            displayExpr="name"
            valueExpr="code"
          >
          </dxo-lookup>
        </dxi-column>
        <dxi-column dataField="machine" caption="Máy">
          <dxo-lookup
            [allowClearing]="true"
            [dataSource]="machines"
            displayExpr="vnName"
            valueExpr="id"
          >
          </dxo-lookup>
        </dxi-column>
        <dxi-column dataField="line" caption="Line">
          <dxo-lookup
            [allowClearing]="true"
            [dataSource]="lines"
            displayExpr="name"
            valueExpr="name"
          >
          </dxo-lookup>
        </dxi-column>

        <dxi-column dataField="userCode" caption="User"></dxi-column>
        <dxi-column dataField="remark" caption="Ghi chú"></dxi-column>

        <!-- <dxi-column
          caption="Action"
          cellTemplate="actionTemplate"
          [fixed]="true"
          fixedPosition="right"
        >
          <div
            *dxTemplate="let item of 'actionTemplate'"
            style="text-align: center"
          >
            <a style="color: red"> Xóa </a>
          </div>
        </dxi-column> -->

        <dxo-paging [pageSize]="10"></dxo-paging>
        <dxo-pager
          [showPageSizeSelector]="true"
          [allowedPageSizes]="[10, 25, 50, 100]"
        >
        </dxo-pager>
      </dx-data-grid>
    </ng-template>

    <ng-template #template2>
      <nz-upload [(nzFileList)]="fileList" [nzBeforeUpload]="beforeUpload">
        <button nz-button>
          <span nz-icon nzType="upload"></span>
          Chọn file upload
        </button>
      </nz-upload>
      <button
        nz-button
        [nzType]="'primary'"
        [nzLoading]="uploading"
        (click)="handleUploadExcel()"
        [disabled]="fileList.length === 0"
        style="margin-top: 16px"
      >
        {{ uploading ? "Uploading" : "Start Upload" }}
      </button>

      <div *ngIf="uploadResult">
        <hr />
        <nz-table
          #errorUploadTable
          nzBordered
          nzSize="small"
          [nzData]="uploadResult?.error"
        >
          <thead>
            <tr>
              <th>Dòng</th>
              <th>Chi tiết lỗi</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let data of errorUploadTable.data">
              <td>{{ data.rowNum }}</td>
              <td>{{ data.error }}</td>
            </tr>
          </tbody>
        </nz-table>
      </div>
    </ng-template>
  </ng-container>
  <div *nzModalFooter>
    <button nz-button nzType="default" (click)="cancelSaveOutputSparePart()">
      Hủy
    </button>
  </div>
</nz-modal>

<!--Edit Spare part modal -->
<nz-modal
  [(nzVisible)]="isOpenModalEditSparePartRecord"
  nzTitle="Edit Spare Part record"
>
  <ng-container *nzModalContent>
    <nz-table [nzData]="['']" nzFrontPagination="false" nzBordered>
      <tbody>
        <tr>
          <td><label>Part No</label></td>
          <td>
            <input nz-input [(ngModel)]="sparePartRecordEdit.partNumber" />
          </td>
        </tr>
        <tr>
          <td><label>Số lượng</label></td>
          <td>
            <input
              nz-input
              type="number"
              [(ngModel)]="sparePartRecordEdit.qty"
            />
          </td>
        </tr>
        <tr>
          <td><label>Nhà máy</label></td>
          <td>
            <nz-select [(ngModel)]="sparePartRecordEdit.factoryCode">
              <nz-option
                *ngFor="let factory of factories"
                [nzLabel]="factory.name"
                [nzValue]="factory.code"
              >
              </nz-option>
            </nz-select>
          </td>
        </tr>
        <tr>
          <td><label>Line</label></td>
          <td>
            <nz-select nzShowSearch [(ngModel)]="sparePartRecordEdit.line">
              <nz-option
                *ngFor="let line of lines"
                [nzLabel]="line.name"
                [nzValue]="line.name"
              >
              </nz-option>
            </nz-select>
          </td>
        </tr>
        <tr>
          <td><label>Máy</label></td>
          <td>
            <nz-select nzShowSearch [(ngModel)]="sparePartRecordEdit.machineId">
              <nz-option
                *ngFor="let machine of machines"
                [nzLabel]="machine.vnName"
                [nzValue]="machine.id"
              >
              </nz-option>
            </nz-select>
          </td>
        </tr>
        <tr>
          <td><label>Người nhận</label></td>
          <td>
            <input nz-input [(ngModel)]="sparePartRecordEdit.receiveUserCode" />
          </td>
        </tr>
        <tr>
          <td><label>Ghi chú</label></td>
          <td>
            <input nz-input [(ngModel)]="sparePartRecordEdit.remark" />
          </td>
        </tr>
      </tbody>
    </nz-table>
  </ng-container>
  <div *nzModalFooter>
    <button
      nz-button
      nz-popconfirm
      nzPopconfirmTitle="Bạn có chắc chắn muốn xóa không ?"
      nzType="primary"
      nzDanger
      style="float: left"
      (nzOnConfirm)="onDeleteSparePartRecord()"
    >
      Xóa
    </button>
    <button
      nz-button
      nzType="default"
      (click)="isOpenModalEditSparePartRecord = false"
    >
      Hủy
    </button>
    <button nz-button nzType="primary" (click)="onEditSparePartRecord()">
      Lưu
    </button>
  </div>
</nz-modal>
